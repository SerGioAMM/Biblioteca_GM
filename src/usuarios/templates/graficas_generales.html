<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graficas generales</title>
    <link rel="icon" href="{{ url_for('static', filename='img/books_3145874.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/estilo_inicio.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/general.css') }}">

    <!--! Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <!--? Tom Select CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.css" rel="stylesheet">
    <!--? Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!--? jsPDF para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="bg-custom">
    <header>
        {% include './navbar.html' %}
    </header>
    <main class="main">
        {% if ((session["rol"]) == "Administrador") or ((session["rol"]) == "Bibliotecario") %}
        <div class="seccion-principal text-middle text-center">
            <div class="fondo-principal">
                <br> <br>
                <h1 id="h1-titulo pt-5">Graficas</h1>
                <h5 id="h5-nota">Aqui podrás ver las graficas generales de los libros y préstamos.</h5>
                <br>
                <!-- Botón para generar PDF -->
                <div class="mt-3 mb-3">
                    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalConfirmarPDF">
                        <i class="bi bi-file-earmark-pdf"></i> Generar PDF
                    </button>
                </div>
            </div>
        </div>
        <div class="contenedor-datos bg-light-custom p-lg-5 p-2">
            <div class="mx-auto col-md-6 mb-3">
                <div class="card text-center border-tertiary">
                    <div class="card-body bg-light-custom">
                    <h5 class="">Distribución de libros por categoría (Sistema Dewey)</h5>
                        <h6 class="card-title"> Total de Libros {{ total_libros }}</h6>
                    </div>
                </div>
            </div>

            <div class="mb-3 w-100 w-lg-75 mx-auto">
                <br>
                <div class="col-lg-10 col-12 mx-auto">
                    <div>
                    <canvas class="w-100" id="grafica1" height="300"></canvas>
                    </div>
                </div>
                <br> <br>
            </div>
        </div>
        
        <div class="contenedor-datos bg-light-custom p-lg-5 p-2">
            <div class="mx-auto col-md-6 mb-3">
                <div class="card text-center border-tertiary">
                    <div class="card-body bg-light-custom">
                        <h5 class="">Préstamos por mes y estado</h5>
                        <h6 class="card-title"> Total de Préstamos {{ total_prestamos }}</h6>
                    </div>
                </div>
            </div>
            
            <div class="mb-3 w-100 w-lg-75 mx-auto">
                <br>
                <div class="col-lg-10 col-12 mx-auto">
                    <div>
                    <canvas class="w-100" id="grafica2" height="500"></canvas>
                    </div>
                </div>
                <br>
            </div>
        </div>

        <!-- Nueva sección para visitantes -->
        <div class="contenedor-datos bg-light-custom p-lg-5 p-2">
            <div class="mx-auto col-md-6 mb-3">
                <div class="card text-center border-tertiary">
                    <div class="card-body bg-light-custom">
                    <h5 class="">Visitantes por mes y género</h5>
                        <h6 class="card-title"> Total de Visitantes {{ total_visitantes }}</h6>
                    </div>
                </div>
            </div>
            
            <div class="mb-3 w-100 w-lg-75 mx-auto">
                <br>
                <div class="col-lg-10 col-12 mx-auto">
                    <div>
                    <canvas class="w-100" id="grafica3" height="400"></canvas>
                    </div>
                </div>
                <br>
            </div>
        </div>
    {% endif %}
    </main>

    <!-- Modal de confirmación para generar PDF -->
    <div class="modal fade" id="modalConfirmarPDF" tabindex="-1" aria-labelledby="modalConfirmarPDFLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 bg-light-custom">
                    <h5 class="modal-title" id="modalConfirmarPDFLabel">
                        <i class="bi bi-file-earmark-pdf text-danger"></i> Generar PDF
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body bg-lighter-custom">
                    <div class="text-center mb-3">
                        <i class="bi bi-info-circle text-primary" style="font-size: 3rem;"></i>
                    </div>
                    <p class="text-center">Se generará un PDF con los siguientes gráficos:</p>
                    <ul class="list-unstyled text-start">
                        <li class="mb-2">
                            <i class="bi bi-pie-chart text-warning me-2"></i>
                            <strong>Gráfico de pie:</strong> Muestra la cantidad de libros por categoría principal.
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-bar-chart text-info me-2"></i>
                            <strong>Gráfico de barras:</strong> Préstamos por mes y estado (activo, devuelto, vencido).
                        </li>
                        <li class="mb-2">
                            <i class="bi bi-bar-chart text-success me-2"></i>
                            <strong>Gráfico de barras:</strong> Cantidad de visitantes por mes.
                        </li>
                    </ul>
                    <div class="alert alert-info mt-3">
                        <i class="bi bi-calendar3 me-2"></i>
                        <strong>Nota:</strong> Los gráficos son generados tomando datos de los últimos 8 meses.
                    </div>
                </div>
                <div class="modal-footer border-0 bg-light-custom">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" onclick="generarPDF()" data-bs-dismiss="modal">
                        <i class="bi bi-file-earmark-pdf"></i> Generar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Footer -->
    {% include 'footer.html' %}

    <!--! Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>

    <!-- Script para las gráficas -->
    <div id="labels_categorias" data-values='{{ labels_categorias | tojson }}'></div>
    <div id="datos_categorias" data-values='{{ datos_categorias | tojson }}'></div>
    <div id="labels_prestamos_mes" data-values='{{ labels_prestamos_mes | tojson }}'></div>
    <div id="datos_vencidos" data-values='{{ datos_vencidos | tojson }}'></div>
    <div id="datos_activos" data-values='{{ datos_activos | tojson }}'></div>
    <div id="datos_devueltos" data-values='{{ datos_devueltos | tojson }}'></div>
    <div id="labels_visitantes_mes" data-values='{{ labels_visitantes_mes | tojson }}'></div>
    <div id="datos_hombres" data-values='{{ datos_hombres | tojson }}'></div>
    <div id="datos_mujeres" data-values='{{ datos_mujeres | tojson }}'></div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx1 = document.getElementById('grafica1');
        const labelsgrafica1 = JSON.parse(document.getElementById('labels_categorias').dataset.values);
        const datografica1 = JSON.parse(document.getElementById('datos_categorias').dataset.values);
        const labelsgrafica2 = JSON.parse(document.getElementById('labels_prestamos_mes').dataset.values);
        const datosvencidos = JSON.parse(document.getElementById('datos_vencidos').dataset.values);
        const datosactivos = JSON.parse(document.getElementById('datos_activos').dataset.values);
        const datosdevueltos = JSON.parse(document.getElementById('datos_devueltos').dataset.values);
        const labelsvisitantesmes = JSON.parse(document.getElementById('labels_visitantes_mes').dataset.values);
        const datoshombres = JSON.parse(document.getElementById('datos_hombres').dataset.values);
        const datosmujeres = JSON.parse(document.getElementById('datos_mujeres').dataset.values);
        new Chart(ctx1, {
            type: 'pie',
            data: {
                labels: labelsgrafica1,
                datasets: [{
                    label: 'Cantidad de libros',
                    data: datografica1,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.6)',
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(255, 206, 86, 0.6)',
                        'rgba(75, 192, 192, 0.6)',
                        'rgba(153, 102, 255, 0.6)',
                        'rgba(100, 200, 100, 0.6)',
                        'rgba(255, 159, 64, 0.6)',
                        'rgba(255, 99, 255, 0.6)',
                        'rgba(255, 180, 120, 0.6)',
                        'rgba(120, 180, 255, 0.6)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(100, 200, 100, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(255, 99, 255, 1)',
                        'rgba(255, 180, 120, 1)',
                        'rgba(120, 180, 255, 1)'
                    ],
                    borderWidth: 2,
                    borderRadius: 2
                }]
            },
            options: {
                responsive: false,
                maintainAspectRatio: true,
                aspectRatio: 1.2,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 12,
                            padding: 5,
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return label + ': ' + value + ' libros (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });

        // Segundo gráfico - Préstamos por mes y estado 
        const ctx2 = document.getElementById('grafica2');

        new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: labelsgrafica2,
                datasets: [{
                    label: 'Vencidos',
                    data: datosvencidos,
                    backgroundColor: 'rgba(220, 53, 69, 0.6)',
                    borderColor: 'rgba(220, 53, 69, 1)',
                    borderWidth: 2,
                    borderRadius: 5
                }, {
                    label: 'Activos',
                    data: datosactivos,
                    backgroundColor: 'rgba(120, 180, 255, 0.6)',
                    borderColor: 'rgba(120, 180, 255, 1)',
                    borderWidth: 2,
                    borderRadius: 5
                }, {
                    label: 'Devueltos',
                    data: datosdevueltos,
                    backgroundColor: 'rgba(25, 135, 84, 0.6)',
                    borderColor: 'rgba(25, 135, 84, 1)',
                    borderWidth: 2,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.dataset.label || '';
                                const value = context.parsed.y;
                                return label + ': ' + value + ' préstamos';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        ticks: {
                            maxRotation: 90,
                            minRotation: 45
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });

        // Tercer grafico - Visitantes por mes y género
        const ctx3 = document.getElementById('grafica3');

        new Chart(ctx3, {
            type: 'bar',
            data: {
                labels: labelsvisitantesmes,
                datasets: [{
                    label: 'Hombres',
                    data: datoshombres,
                    backgroundColor: 'rgba(54, 162, 235, 0.8)', // Azul
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    borderRadius: 5
                }, {
                    label: 'Mujeres',
                    data: datosmujeres,
                    backgroundColor: 'rgba(255, 99, 132, 0.8)', // Rosa
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 2,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            boxWidth: 12,
                            padding: 10,
                            font: {
                                size: 14
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y + ' visitantes';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        stacked: true,
                        ticks: {
                            font: {
                                size: 12
                            }
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    });

    // Función para generar PDF
    function generarPDF() {
        // Mostrar alerta de progreso
        if (window.showAlert) {
            window.showAlert('Generando PDF, por favor espere...', 'info', 8000, 'bi-file-earmark-pdf');
        }

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        // Título del documento
        pdf.setFontSize(20);
        pdf.setFont('helvetica', 'bold');
        pdf.text('Gráficas Generales - Biblioteca Gabriela Mistral', 20, 20);
        
        // Fecha actual
        const fecha = new Date().toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'long', 
            day: 'numeric'
        });
        pdf.setFontSize(12);
        pdf.setFont('helvetica', 'normal');
        pdf.text(`Fecha de generación: ${fecha}`, 20, 30);
        
        let currentY = 50;
        
        // Función para agregar gráfica al PDF con mejor calidad
        function agregarGrafica(canvasId, titulo, isFirstChart = false, callback) {
            const canvas = document.getElementById(canvasId);
            
            // Crear un canvas temporal optimizado para PDF
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            // Configurar dimensiones según el tipo de gráfico para mejor calidad
            let width, height;
            if (isFirstChart) {
                // Para el gráfico de pie, usar dimensiones que mantengan buena proporción
                width = 650;  // Ancho optimizado para el gráfico de pie
                height = 500; // Alto optimizado para el gráfico de pie
            } else {
                // Para gráficos de barras
                width = 800;
                height = 500;
            }
            
            tempCanvas.width = width;
            tempCanvas.height = height;
            
            // Fondo blanco para el PDF
            tempCtx.fillStyle = 'white';
            tempCtx.fillRect(0, 0, width, height);
            
            // Obtener las dimensiones actuales del canvas original
            const originalWidth = canvas.width;
            const originalHeight = canvas.height;
            
            // Escalar y dibujar el canvas original en el temporal
            // Calcular la escala para mantener la proporción
            const scaleX = width / originalWidth;
            const scaleY = height / originalHeight;
            const scale = Math.min(scaleX, scaleY);
            
            // Calcular posición para centrar la imagen
            const scaledWidth = originalWidth * scale;
            const scaledHeight = originalHeight * scale;
            const offsetX = (width - scaledWidth) / 2;
            const offsetY = (height - scaledHeight) / 2;
            
            // Dibujar el canvas original escalado y centrado
            tempCtx.drawImage(canvas, offsetX, offsetY, scaledWidth, scaledHeight);
            
            const imgData = tempCanvas.toDataURL('image/png', 1.0);
            
            // Verificar si necesitamos nueva página
            if (currentY > 180) {
                pdf.addPage();
                currentY = 20;
            }
            
            // Título de la gráfica
            pdf.setFontSize(14);
            pdf.setFont('helvetica', 'bold');
            pdf.text(titulo, 20, currentY);
            currentY += 10;
            
            // Calcular dimensiones para el PDF
            let pdfWidth, pdfHeight;
            if (isFirstChart) {
                // Gráfico de pie: mantener proporciones optimizadas
                pdfWidth = 160;
                pdfHeight = 120;
            } else {
                // Gráficos de barras: más ancho, menos alto
                pdfWidth = 170;
                pdfHeight = 100;
            }
            
            // Centrar la imagen
            const xPosition = (210 - pdfWidth) / 2; // 210mm es el ancho de A4
            
            // Agregar imagen de la gráfica con mejor calidad
            pdf.addImage(imgData, 'PNG', xPosition, currentY, pdfWidth, pdfHeight, '', 'FAST');
            currentY += pdfHeight + 15;
            
            if (callback) callback();
        }
        
        // Agregar las tres gráficas con tiempos de espera para renderizado
        setTimeout(() => {
            agregarGrafica('grafica1', 'Distribución de libros por categoría (Sistema Dewey)', true, () => {
                setTimeout(() => {
                    agregarGrafica('grafica2', 'Préstamos por mes y estado', false, () => {
                        setTimeout(() => {
                            agregarGrafica('grafica3', 'Visitantes por mes y género', false, () => {
                                // Información adicional en la última página
                                pdf.addPage();
                                pdf.setFontSize(16);
                                pdf.setFont('helvetica', 'bold');
                                pdf.text('Información adicional', 20, 30);
                                
                                pdf.setFontSize(12);
                                pdf.setFont('helvetica', 'normal');
                                pdf.text('• Los datos mostrados corresponden a los últimos 8 meses', 20, 50);
                                pdf.text('• Sistema de clasificación: Dewey Decimal Classification', 20, 65);
                                pdf.text('• Estados de préstamos: Activo, Devuelto, Vencido', 20, 80);
                                pdf.text('• Visitantes clasificados por género', 20, 95);
                                
                                pdf.setFontSize(10);
                                pdf.text('Generado por Sistema de Biblioteca Gabriela Mistral', 20, 280);
                                
                                // Guardar el PDF
                                const nombreArchivo = 'graficas-biblioteca-' + new Date().toISOString().split('T')[0] + '.pdf';
                                pdf.save(nombreArchivo);
                                
                                // Mostrar alerta de éxito
                                if (window.showAlert) {
                                    window.showAlert('PDF generado exitosamente: ' + nombreArchivo, 'success', 4000, 'bi-check-circle-fill');
                                }
                            });
                        }, 1000);
                    });
                }, 1000);
            });
        }, 1000);
    }
    </script>
</body>
</html>